# zug.lol
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

A web application that can retrieves prices for train journeys within Austria (via [oebb.at](https://www.oebb.at))
and allows you to create a travel journal to determine if a [Klimaticket](https://www.klimaticket.at/) pays off.

## Components

The application uses the following components.

1. [Flask](https://flask.palletsprojects.com) for the backend
2. [htmx](https://htmx.org/) for asynchronous HTTP requests
   and [server-sent events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
3. [Bootstrap](https://getbootstrap.com/) for front end layout

## Run

To run the application locally follow these steps.

1. Create and activate a virtual environment
    ```
    python -m venv venv
    source venv/bin/activate
    ```
2. Install dependencies
    ```
    pip install -r requirements.txt
    ```
3. Setup a PostgreSQL database and configure it via
4. Adapt the config, either by changing the contents in ```config.py``` or by pointing the environment
   variable ```APPLICATION_SETTINGS``` to an alternative file.
   At least the following variables need to be changed:
   ```
   FLASK_SECRET_KEY # should be generated by secrets.token_urlsafe()
   FLASK_SECURITY_PASSWORD_SALT # should be generated by secrets.SystemRandom().getrandbits(128)
   SQLALCHEMY_DATABASE_URI # Should point to the database configured in the previous step
   RECAPTCHA_PUBLIC_KEY
   RECAPTCHA_PRIVATE_KEY
   ```

5. Initialize the database
   ```
   flask init-db
   ```
6. Adapt the translation
   ```bash
   pybabel extract -F babel.cfg -k lazy_gettext -o messages.pot .
   pybabel update -i messages.pot -d app/translations
   # Adapt app/translations/de/LC_MESSAGES/messages.po
   pybabel compile -d app/translations
   ```
7. Upgrade the database schema:
   ```bash
   flask db upgrade
   ```
8. Run the app
    ```
    export FLASK_DEBUG=True
    export FLASK_APP=app
    flask run
    ```
9. Open in your browser: http://localhost:5000
10. Install pre-commit checks before committing
    ```
    pre-commit install
    ```

## Live Demo

A live version can be reached at https://zug.lol

## Deploy

The following files can be helpful to deploy the application:

1. `zug-lol.service` as systemd service file.
2. `wsgi.py` to start the WSGI.
3. `post-receive` as git post-receive hook to finish deployment. To use it the deploy user needs to have password-less
   sudo access to the systemctl command to restart the service, e.g. via `sudo visudo` add
   ```
   %sudo   ALL=(ALL:ALL) NOPASSWD: /bin/systemctl restart zug-lol.service
   ```

To use nginx as a proxy the following config snippet can be used inside a ```server``` section.

```
location / {
   include proxy_params;
   proxy_pass http://unix:/var/www/zug-lol/zug-lol.sock;
   proxy_buffering off;
}
```
